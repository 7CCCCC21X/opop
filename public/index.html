<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Superchain æ‰¹é‡ç§¯åˆ†æŸ¥è¯¢</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 30px; }
    button, input { padding: 10px; font-size: 14px; margin: 5px 0; }
    input[type="text"] { width: 100%; }
    progress { width: 100%; height: 20px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    #status, #lastUpdate { margin-top: 10px; font-size: 14px; color: #555; }
  </style>
</head>
<body>

  <h2>Superchain Leaderboard æŸ¥è¯¢å·¥å…·</h2>

  <button onclick="updateData()">ğŸ” æ›´æ–°æ•°æ®</button>
  <progress id="progress" value="0" max="2000"></progress>
  <div id="status">æœªå¼€å§‹</div>
  <div id="lastUpdate"></div>

  <h3>æŸ¥è¯¢åœ°å€ä¿¡æ¯</h3>
  <input type="text" id="searchInput" placeholder="è¾“å…¥é’±åŒ…åœ°å€ 0x..." oninput="searchAddress()" />
  <table>
    <thead>
      <tr>
        <th>åœ°å€</th>
        <th>ç§¯åˆ†</th>
        <th>å¾½ç« æ•°</th>
        <th>SuperChain ID</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script>
    const API_URL = "/api/leaderboard";
    const MAX_PAGE = 2000;          // âœ… æ”¹ä¸º 2000 é¡µ
    const CONCURRENCY = 20;         // âœ… å¹¶å‘åŠ å¿«ä¸º 20

    let leaderboardData = [];

    function saveToCache(data) {
      const now = new Date().toISOString();
      localStorage.setItem("leaderboardData", JSON.stringify(data));
      localStorage.setItem("lastUpdate", now);
      updateLastUpdateUI(now);
    }

    function loadFromCache() {
      const cached = localStorage.getItem("leaderboardData");
      const time = localStorage.getItem("lastUpdate");
      if (cached) {
        leaderboardData = JSON.parse(cached);
        document.getElementById("status").innerText = `âœ… å·²åŠ è½½æœ¬åœ°ç¼“å­˜ï¼Œå…± ${leaderboardData.length} æ¡è®°å½•`;
        updateLastUpdateUI(time);
      }
    }

    function updateLastUpdateUI(time) {
      if (time) {
        const dt = new Date(time);
        document.getElementById("lastUpdate").innerText = `ğŸ•’ ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼š${dt.toLocaleString()}`;
      }
    }

    function chunk(arr, size) {
      const chunks = [];
      for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
      }
      return chunks;
    }

    async function updateData() {
      leaderboardData = [];
      const pages = Array.from({ length: MAX_PAGE }, (_, i) => i + 1);
      const chunks = chunk(pages, CONCURRENCY);
      const progress = document.getElementById("progress");
      const status = document.getElementById("status");
      let completed = 0;

      for (const group of chunks) {
        const promises = group.map(page =>
          fetch(`${API_URL}?page=${page}`)
            .then(res => res.json())
            .then(json => json.data || [])
            .catch(() => [])
        );

        const results = await Promise.all(promises);
        results.flat().forEach(item => {
          leaderboardData.push({
            address: item.superaccount,
            points: item.total_points,
            badges: item.total_badges,
            chain: item.superChainId
          });
        });

        completed += group.length;
        progress.value = completed;
        status.innerText = `ğŸ”„ å·²æ›´æ–° ${completed} / ${MAX_PAGE} é¡µï¼Œå…± ${leaderboardData.length} æ¡è®°å½•`;
      }

      saveToCache(leaderboardData);
      status.innerText = `âœ… æ•°æ®æ›´æ–°å®Œæˆï¼Œå…± ${leaderboardData.length} æ¡è®°å½•`;
    }

    function searchAddress() {
      const val = document.getElementById("searchInput").value.trim().toLowerCase();
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = "";

      if (!val || val.length < 6) return;

      const result = leaderboardData.filter(entry => entry.address.toLowerCase().includes(val));
      for (const r of result) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.address}</td>
          <td>${r.points}</td>
          <td>${r.badges}</td>
          <td>${r.chain}</td>
        `;
        tbody.appendChild(row);
      }
    }

    window.onload = loadFromCache;
  </script>

</body>
</html>
